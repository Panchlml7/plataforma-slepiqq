<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Acompa√±amiento Visita - SLEP IQUIQUE</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="doc/style.css">
  <link rel="icon" type="image/png" href="../Imagen/slepiqq.png">
</head>

<body>
  <nav class="top-nav">
    <span class="brand">SLEPIQQ</span>
    <a class="nav-link" href="#asistencia">Asistencia</a>
    <a class="nav-link" href="establecimiento.html">Establecimiento</a>
    <div class="dropdown nav-acomp-dropdown" aria-label="Acompa√±amiento Visita">
      <button class="dropdown-toggle" type="button" aria-haspopup="true" aria-expanded="false">
        Acompa√±amiento <span class="caret">‚ñæ</span>
      </button>
      <div class="dropdown-menu" role="menu" aria-label="Acompa√±amiento Visita">
        <a class="dropdown-item" role="menuitem" href="documentos.html" title="Documento de Acompa√±amiento">DOCUMENTO</a>
        <a class="dropdown-item" role="menuitem" href="planilla.html" title="Planilla de Acompa√±amiento">PLANILLA</a>
      </div>
    </div>
    <a class="nav-link" href="../plataforma.html">INICIO</a>
    <span class="user-badge"><span id="userName">...</span><button id="logoutBtn" class="btn" type="button">Salir</button></span>
  </nav>

  <main>
    <!-- Pesta√±as principales -->
    <div class="main-tabs-navigation">
      <button id="tabNuevo" class="main-tab active">Nuevo Documento</button>
      <button id="tabGuardados" class="main-tab">Documentos Guardados</button>
    </div>

    <!-- Estad√≠sticas -->
    <div class="stats-section">
      <div class="stat-card"><div class="num" id="statTotal">0</div><div class="lbl">Documentos Totales</div></div>
      <div class="stat-card"><div class="num" id="statEst">0</div><div class="lbl">Establecimientos</div></div>
      <div class="stat-card"><div class="num" id="statMes">0</div><div class="lbl">Este Mes</div></div>
      <div class="stat-card"><div class="num" id="statAses">0</div><div class="lbl">Asesores</div></div>
    </div>

    <!-- Secci√≥n: Nuevo Documento (wizard existente) -->
    <div id="nuevo-documento" class="main-content-section active">
      <!-- ABRIR FORM: envuelve ambos pasos y acciones -->
      <form id="datosBasicosForm" class="section-card">
        <!-- Paso 1: Datos B√°sicos -->
        <div class="wizard-step" data-step="1">
          <div class="wizard-legend" style="text-align: end;">Paso 1 de 2: Datos B√°sicos</div>
          <!-- Informaci√≥n General -->
          <h1 style="text-align: center;">Acta de Acompa√±amiento T√©cnico UATP</h1>
          <div class="grid cols-2">
            <div>
              <label class="small" for="actaNumber">N¬∞ Acta (autom√°tica)</label>
              <input id="actaNumber" name="actaNumber" type="text" readonly style="text-align: center;">
            </div>
            <div>
              <label class="small" for="fecha">Fecha</label>
              <input id="fecha" name="fecha" type="date" required style="text-align: center;">
            </div>
          </div>

          <!-- Establecimiento y Ubicaci√≥n -->
          <h2 style="margin-top:1rem;">DATOS INSTITUCI√ìN VISITADA</h2>
          <div class="grid cols-2">
            <div>
              <label class="small" for="establecimiento">Establecimiento</label>
              <select id="establecimiento" name="establecimiento" required>
                <option value="" disabled selected>Selecciona establecimiento</option>
                <!-- Se cargar√° din√°micamente desde Firestore; fallback est√°tico en script -->
              </select>
              
            <div class="full">
              <label class="small" for="objetivoEstrategico">Objetivo Estrat√©gico</label>
              <textarea id="objetivoEstrategico" name="objetivoEstrategico" required
                placeholder="Describe el objetivo estrat√©gico..."></textarea>
            </div>
            </div>
            <div>
              <label class="small" for="rbd">RBD</label>
              <input id="rbd" name="rbd" type="text" placeholder="Ej: 12345-6" required>
            </div>
            <div>
              <label class="small" for="director">Director/a de Establecimiento</label>
              <input id="director" name="director" type="text" placeholder="Nombre del/la director/a">
            </div>
          </div>

          <!-- Equipo de Asesores -->
          <h2 style="margin-top:1rem;">Equipo de Asesores</h2>
          <div class="grid cols-2">
            <div>
              <label class="small" for="asesorPrincipal">Asesor principal</label>
              <input id="asesorPrincipal" name="asesorPrincipal" type="text" required>
            </div>
            <div>
              <label class="small" for="asesorSegundo">Asesor segundo</label>
              <input id="asesorSegundo" name="asesorSegundo" type="text">
            </div>
          </div>

          <!-- Horario y Modalidad -->
          <h2 style="margin-top:1rem;">Horario y Modalidad</h2>
          <div class="grid cols-2">
            <div>
              <label class="small" for="horaInicio">Hora inicio (opcional)</label>
              <input id="horaInicio" name="horaInicio" type="time">
            </div>
            <div>
              <label class="small" for="horaTermino">Hora t√©rmino (opcional)</label>
              <input id="horaTermino" name="horaTermino" type="time">
            </div>
            <div class="full">
              <label class="small" for="modalidad">Modalidad</label>
              <select id="modalidad" name="modalidad" required>
                <option value="" disabled selected>Selecciona modalidad</option>
                <option>Presencial</option>
                <option>Remoto</option>
                <option>H√≠brida</option>
              </select>
              <small style="display:block;opacity:.75;margin-top:.35rem;">
                Puedes dejar las horas vac√≠as y agregarlas m√°s adelante.
              </small>
            </div>
          </div>

          <!-- Capacidades y competencias -->
          <h2 style="margin-top:1rem;">Capacidades y competencias</h2>
          <div class="grid cols-2">
            <div>
              <label class="small" for="cicloApoyo">Ciclo de Apoyo T√©cnico Pedag√≥gica</label>
              <select id="cicloApoyo" name="cicloApoyo" required>
                <option value="" disabled selected>Selecciona</option>
                <option value="Involucramiento">Involucramiento</option>
                <option value="Diagn√≥stico">Diagn√≥stico</option>
                <option value="Planificaci√≥n">Planificaci√≥n</option>
                <option value="Ejecuci√≥n">Ejecuci√≥n</option>
                <option value="Evaluaci√≥n">Evaluaci√≥n</option>
              </select>
            </div>
            <div>
              <label class="small" for="capacidadBasal">Capacidad Basal Focalizada</label>
              <select id="capacidadBasal" name="capacidadBasal" required>
                <option value="" disabled selected>Selecciona</option>
                <option value="Reflexi√≥n">Reflexi√≥n</option>
                <option value="Colaboraci√≥n">Colaboraci√≥n</option>
                <option value="Confianza Relacional">Confianza Relacional</option>
                <option value="Liderazgo Distribuido">Liderazgo Distribuido</option>
              </select>
            </div>
            <div>
              <label class="small" for="nivelImplementacion">Nivel de Implementaci√≥n Capacidad Basal</label>
              <select id="nivelImplementacion" name="nivelImplementacion" required>
                <option value="" disabled selected>Selecciona</option>
                <option value="Exploraci√≥n">Exploraci√≥n</option>
                <option value="Emergente">Emergente</option>
                <option value="Satisfactoria">Satisfactoria</option>
                <option value="Sustentabilidad">Sustentabilidad</option>
              </select>
            </div>
            <div>
              <label class="small" for="rolProfesional">Rol profesional Acompa√±amiento</label>
              <select id="rolProfesional" name="rolProfesional" required>
                <option value="" disabled selected>Selecciona</option>
                <option value="Acompa√±ante">Acompa√±ante</option>
                <option value="Orientador">Orientador(a)</option>
                <option value="Facilitador">Facilitador(a)</option>
                <option value="Articulador">Articulador(a)</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Paso 2: Desarrollo de visita -->
        <div class="wizard-step hidden" data-step="2">
          <div class="wizard-legend">Paso 2 de 2: Desarrollo de visita</div>

          <h2>Objetivo de la visita</h2>
          <div class="grid">
            <div class="full">
              <label class="small" for="objetivoVisita">Objetivo</label>
              <textarea id="objetivoVisita" name="objetivoVisita" required placeholder="Describe el objetivo de la visita..."></textarea>
            </div>
          </div>

          <div class="grid">
            <div class="full">
              <label class="small" for="antecedentes">Antecedentes</label>
              <textarea id="antecedentes" name="antecedentes" placeholder="Antecedentes relevantes..."></textarea>
            </div>
          </div>

          <div class="grid">
            <div class="full">
              <label class="small" for="instrumentos">Instrumentos / Insumos</label>
              <textarea id="instrumentos" name="instrumentos" placeholder="Listar instrumentos o insumos utilizados..."></textarea>
            </div>
          </div>

          <div class="grid">
            <div class="full">
              <label class="small" for="practicaProblematica">Pr√°ctica problem√°tica</label>
              <textarea id="practicaProblematica" name="practicaProblematica" placeholder="Describir la pr√°ctica problem√°tica observada..."></textarea>
            </div>
          </div>

          <h2 style="margin-top:1rem;">Actividades realizadas</h2>
          <div class="grid">
            <div class="full">
              <label class="small" for="actividadesRealizadas">Actividades</label>
              <textarea id="actividadesRealizadas" name="actividadesRealizadas" placeholder="Detalle de actividades realizadas..."></textarea>
            </div>
          </div>

          <h2 style="margin-top:1rem;">Acuerdos</h2>
          <div class="grid cols-2">
            <div class="full">
              <label class="small" for="acuerdos">Acuerdos/ Fecha de la implementaci√≥n/ Responsables</label>
              <textarea id="acuerdos" name="acuerdos" placeholder="Compromisos y acuerdos..."></textarea>
            </div>            
          </div>

          <h2 style="margin-top:1rem;">Observaciones</h2>
          <div class="grid cols-2">
            <div class="full">
              <label class="small" for="aspectosPositivos">Aspectos positivos observados</label>
              <textarea id="aspectosPositivos" name="aspectosPositivos" placeholder="Aspectos positivos..."></textarea>
            </div>
            <div class="full">
              <label class="small" for="areasMejora">√Åreas de mejora identificadas</label>
              <textarea id="areasMejora" name="areasMejora" placeholder="√Åreas de mejora..."></textarea>
            </div>
          </div>
        </div>

        <!-- Acciones wizard -->
        <div class="wizard-actions">
          <button type="button" id="btnBack" class="btn" disabled>Atr√°s</button>
          <!-- NUEVO: vista previa antes de guardar -->
          <button type="button" id="btnPreview" class="btn">Vista Previa</button>
          <button type="button" id="btnNext" class="btn">Siguiente</button>
          <button type="submit" id="btnSubmit" class="btn hidden">Guardar</button>
        </div>
      </form>
      <!-- CERRAR FORM -->
    </div>

    <!-- Secci√≥n: Documentos Guardados -->
    <div id="documentos-guardados" class="main-content-section">
      <div class="search-card">
        <h3 style="margin:.1rem 0 .7rem; display:flex; align-items:center; gap:.5rem; color:#000;">
          <span style="font-size:1.1rem;">üîé</span> Buscar Documentos
        </h3>
        <div class="search-row">
          <input id="searchBox" type="text" placeholder="Buscar por N¬∞ ACTA, establecimiento, asesor, fecha, modalidad, capacidad">
          <button id="btnSearch" class="btn-sm" style="background:#7c3aed;color:#fff;">Buscar</button>
          <button id="btnClear" class="btn-sm" style="background:#374151;color:#fff;">Limpiar</button>
        </div>
        <!-- Visibilidad fija: solo Mis documentos -->
        <div class="search-row" style="margin-top:.5rem; gap:1rem; color:#111827;">
          <span style="font-size:.85rem;">Visibilidad:</span>
          <span>Mis documentos</span>
        </div>
        <small style="display:block;opacity:.75;margin-top:.5rem; color: #000;">Busca por cualquier campo. Consejo: para N¬∞ ACTA exacto, escribe el c√≥digo completo (ej: ACT-20240809-123).</small>
        <hr style="border:none;border-top:1px solid #e5e7eb; margin:.8rem 0;">
        <div class="chips">
          <button type="button" class="chip" data-filter="Presencial">üìå Presencial</button>
          <button type="button" class="chip" data-filter="Remoto">üíª Virtual</button>
          <button type="button" class="chip" data-filter="H√≠brida">üîÄ H√≠brida</button>
          <button type="button" class="chip" data-filter="Recientes">‚ö° Recientes</button>
          <button type="button" class="chip active" data-filter="Todos">üìÑ Todos</button>
        </div>
        <div class="search-row">
          <button id="btnPrintAll" class="btn-sm" style="background:#dc2626;color:#fff;">PDF (todos)</button>
        </div>
        <!-- Estado de conexi√≥n/permiso y reconexi√≥n -->
        <div class="search-row" style="margin-top:.5rem; align-items: center; gap:.5rem;">
          <button id="btnReconnect" class="btn-sm" type="button" title="Reintentar suscripci√≥n">Reconectar</button>
          <button id="btnDiag" class="btn-sm" type="button" title="Diagn√≥stico r√°pido Firebase">Diagn√≥stico</button>
          <span id="docsInfo" style="font-size:.9rem; color:#111827;"></span>
        </div>
      </div>

  <div id="results" class="results doc-grid"></div>
    </div>
  </main>

  <!-- Contenedor imprimible (se llena al exportar) -->
  <div id="printAll" class="print-area">
    <!-- Se inyectan p√°ginas con class="print-page" -->
  </div>

  <footer>&copy; SLEP IQUIQUE</footer>

  <!-- Modal: Ver Completo -->
  <div id="viewModal" class="hidden" role="dialog" aria-modal="true" aria-labelledby="viewModalTitle">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="viewModalTitle" style="margin:0;">Detalle del Documento</h3>
        <button class="btn-sm btn-del" type="button" data-close-view title="Cerrar">‚úï</button>
      </div>
      <div class="modal-content" id="viewModalBody">
        <!-- contenido inyectado din√°micamente -->
      </div>
      <div class="modal-footer">
        <span style="font-size:.8rem;opacity:.75;">Presiona ESC para cerrar</span>
        <button class="btn" type="button" data-close-view>Cerrar</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Carga din√°mica de Firebase con fallback de versi√≥n
    async function loadFirebase(version){
      const base = `https://www.gstatic.com/firebasejs/${version}`;
      const appMod = await import(`${base}/firebase-app.js`);
      const authMod = await import(`${base}/firebase-auth.js`);
      const fsMod = await import(`${base}/firebase-firestore.js`);
      return { appMod, authMod, fsMod };
    }
    let appMod, authMod, fsMod;
    try {
      ({ appMod, authMod, fsMod } = await loadFirebase('10.12.2'));
    } catch (e1) {
      try {
        ({ appMod, authMod, fsMod } = await loadFirebase('10.12.3'));
        console.warn('Firebase 10.12.2 no disponible; usando 10.12.3');
      } catch (e2) {
        console.error('No se pudo cargar Firebase desde la CDN:', e1, e2);
        alert('No se pudo cargar Firebase (CDN bloqueada o sin red). Permite www.gstatic.com o usa una red distinta.');
        throw e2;
      }
    }
    const { initializeApp } = appMod;
    const { getAuth, onAuthStateChanged, signOut } = authMod;
    const { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, getDocs, onSnapshot, query, where, updateDoc } = fsMod;

  // Logo de impresi√≥n: archivo local (ruta relativa al HTML)
  const PRINT_LOGO_URL = '../Imagen/slepiqq.png';
  // Precarga simple del logo para mejorar aparici√≥n en PDF
  const _preloadLogo = (()=>{ const img = new Image(); img.src = PRINT_LOGO_URL; return img; })();

    const firebaseConfig = { apiKey: "AIzaSyDzUGdJT-eyYjKtej63iThVLgvTHVzvxvA", authDomain: "ia-slep-iqq.firebaseapp.com", projectId: "ia-slep-iqq", storageBucket: "ia-slep-iqq.appspot.com", messagingSenderId: "528895424744", appId: "1:528895424744:web:7144f5e5db1bce5ffb315d" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

  const userNameEl = document.getElementById('userName');
  const logoutBtn = document.getElementById('logoutBtn');
  let currentUser = null; // para permisos de edici√≥n/borrado

  // Cerrar sesi√≥n (Salir)
  logoutBtn?.addEventListener('click', async (e) => {
    e.preventDefault();
    try {
      await signOut(auth);
    } catch (err) {
      console.error(err);
      alert('Error al cerrar sesi√≥n');
    } finally {
      // Redirigir siempre al login
      location.replace('../index.html');
    }
  });

    // Cargar perfil usuario (nombre y rol)
    let currentUserRole = 'user';
    async function loadProfile(uid, email) {
      let role = 'user';
      try {
        const snap = await getDoc(doc(db, 'users', uid));
        if (snap.exists()) {
          const data = snap.data();
          userNameEl.textContent = data.name ? data.name : (email || uid);
          role = (data.role || 'user').toString().toLowerCase();
        } else {
          userNameEl.textContent = email || uid;
        }
      } catch {
        userNameEl.textContent = email || uid;
      }
      currentUserRole = role;
      return role;
    }

    // Generar N¬∞ Acta
    function genActa() {
      const d = new Date();
      const pad = n => String(n).padStart(2, '0');
      const code = `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
      const rnd = Math.floor(100 + Math.random() * 900);
      return `ACT-${code}-${rnd}`;
    }
    document.getElementById('actaNumber').value = genActa();

    // Cargar establecimientos (Firestore > establecimientos) con fallback
  async function loadEstablecimientos() {
      const sel = document.getElementById('establecimiento');
      sel.innerHTML = '<option value="" disabled selected>Cargando...</option>';
      const fallback = [
        { name: 'SLEP IQUIQUE - Oficina Central', rbd: 'SLEP IQUIQUE'},
        { name: 'Instituto Comercial Baldomero Wolnitzky', rbd: '97', directorName: 'Land-Yen Beatriz Davila Castillo' },
        { name: 'Esc. Educ. Especial Flor Del Inca', rbd: '102', directorName: 'Ivonne Del Carmen Alonso Oyarzo' },
        { name: 'Esc. Educ.Gral. Bas. Y Des. Art. Violeta Parra', rbd: '103', directorName: 'Juana Cecilia Rojas Fredes' },
        { name: 'Centro De Capacitaci√≥n Laboral', rbd: '105', directorName: 'Sandra Veronica Figueroa Meneses' },
        { name: 'Liceo Libert. Gral. Bernardo O Higgins', rbd: '107', directorName: 'Sebastian Yuk-Kin Chang Brack' },
        { name: 'Liceo Politec. Jos√© Guti√©rrez De La Fuente', rbd: '108', directorName: 'Ingrid Soledad Cofr√© Castro' },
        { name: 'Liceo Deportivo T√©cnico Profesional Elena Duvauchelle Cabez√≥n', rbd: '109', directorName: 'Cristian Eduardo Bugue√±o Marambio' },
        { name: 'Liceo Bicentenario Domingo Santa Mar√≠¬≠a', rbd: '110', directorName: 'Mar√≠a Ver√≥nica Ormaz√°bal Vera' },
        { name: 'Esc. Gabriela Mistral', rbd: '111', directorName: 'Mar√≠a Amparo Del Carmen Lobos Estay' },
        { name: 'Esc. Eduardo Llanos', rbd: '112', directorName: 'Hugo Manuel Alegria Miranda' },
        { name: 'Esc. Almirante Patricio Lynch', rbd: '113', directorName: 'Lilia Del Carmen Espinosa Tapia' },
        { name: 'Esc. Placido Villarroel', rbd: '114', directorName: 'Anicia Malvina Gonz√°lez Guti√©rrez' },
        { name: 'Colegio Rep√∫blica De Croacia', rbd: '116', directorName: 'Jorge Eduardo Aracena Cerda' },
        { name: 'Esc. Paula Jaraquemada Alquizar', rbd: '117', directorName: 'Marjorie Marcia Cortez Rojas' },
        { name: 'Esc. Centenario De La Rep√∫blica De Chile', rbd: '119', directorName: 'Marta Victoria Ruz P√©rez' },
        { name: 'Esc. Thilda Portillo Olivares', rbd: '122', directorName: 'Julia Elizabeth D√°vila Olivares' },
        { name: 'Colegio Espa√±a', rbd: '123', directorName: 'Rosa Elizabeth C√≥rdova Alache' },
        { name: 'Liceo Luis Cruz Mart√≠nez', rbd: '124', directorName: 'Eduardo Manfredo Gonz√°lez Estay' },
        { name: 'Esc. Profesor Manuel Castro Ramos', rbd: '125', directorName: 'Gilberto Eduardo Mi√±os Parra' },
        { name: 'Colegio Rep√∫blica De Italia', rbd: '126', directorName: 'Miguel Eleazar Baez Carre√±o' },
        { name: 'Esc. Caleta Chanavayita', rbd: '10916', directorName: 'Sixto Rosendo Pure Calane' },
        { name: 'LICEO BICENTENARIO MINERO SS JUAN PABLO II', rbd: '10917', directorName: 'Goighet Dionisia Andrade Yana' },
        { name: 'Esc. Chipana', rbd: '12538', directorName: 'C√©sar Humberto Sep√∫lveda Villarroel' },
        { name: 'Esc. Caleta San Marcos', rbd: '12542', directorName: 'M√≥nica Patricia Cabezas Castillo' },
        { name: 'COLEGIO SIMON BOLIVAR', rbd: '12632', directorName: 'Paul Enrique Spaudo Vasquez' },
        { name: 'ESC ESP DE LENGUAJE OASIS DEL SABER', rbd: '12739', directorName: 'Katherine Colomba Bravo Mu√±oz' },
        { name: 'Liceo Jos√© Alejandro Soria Varas', rbd: '12758', directorName: 'H√©ctor Gilberto Inostroza Rojas' },
        { name: 'LICEO TECNICO PROFESIONAL DE ADULTOS', rbd: '40429', directorName: 'Nancy Del Carmen P√©rez Lobos' },
        { name: 'J. I. OASIS DEL SABER', rbd: '33019', directorName: 'Carla Andrea Araya Cadag√°n' },
        { name: 'J. I. INTINA WAWAPA', rbd: '33020', directorName: 'Maritza Rossana P√©rez Guerrero' },
        { name: 'J. I. LOS NARANJOS', rbd: '33021', directorName: 'Ana Maria Inzunza Fontecilla' },
        { name: 'J. I. TORTUGUITAS', rbd: '33022', directorName: 'Marjorie Lorna D√≠az Longa' },
        { name: 'J. I. ARUMANTI', rbd: '33024', directorName: 'Madeleine Jes√∫s Baez Matamala' },
        { name: 'J. I. LUCERITO DORADO', rbd: '33025', directorName: 'Michelle Alejandra Longa Bautista' },
        { name: 'J. I. AVENTURAS DE APRENDER', rbd: '33026', directorName: 'Karina Daisy Alca√≠no Alfaro' },
        { name: 'J. I. ARCOIRIS DEL DESIERTO', rbd: '33027', directorName: 'Ximena Del Carmen Lara Rivas' },
        { name: 'J. I. MAGIA DE APRENDER', rbd: '33028', directorName: 'Danitza Patricia Pi√±ones Rosskoff' },
        { name: 'J. I. MI PEQUE√ëO MUNDO', rbd: '33030', directorName: 'Daniela Alejandra Loayza Loyola' },
        { name: 'J. I. SUMA INTI', rbd: '35987', directorName: 'Carla Amanda Milena Clery Cabezas' },
        { name: 'J. I. CARITA DE SOL', rbd: '33015', directorName: 'Loreto Ester Videla Vasquez' },
      ];
      try {
        const snap = await getDocs(collection(db, 'establecimientos'));
        const items = snap.empty ? fallback : snap.docs.map(d => ({
          name: d.data().name || d.id,
          rbd: d.data().rbd || '',
          directorName: d.data().directorName || d.data().director || d.data().directorEstablecimiento || ''
        }));
        sel.innerHTML = '<option value="" disabled selected>Selecciona establecimiento</option>';
        for (const it of items) {
          const opt = document.createElement('option');
          opt.value = it.name;
          opt.textContent = it.name;
          if (it.rbd) opt.setAttribute('data-rbd', it.rbd);
          if (it.directorName) opt.setAttribute('data-director', it.directorName);
          sel.appendChild(opt);
        }
      } catch (e) {
        // Silenciar detalle cuando es por permisos y usar fallback local
        const msg = (e && (e.code === 'permission-denied' || e.message?.includes('permission'))) ? 'Sin permisos para leer establecimientos; usando lista local.' : 'No se pudo cargar establecimientos; usando lista local.';
        console.warn(msg);
        sel.innerHTML = '<option value="" disabled selected>Selecciona establecimiento</option>';
        for (const it of fallback) {
          const opt = document.createElement('option');
          opt.value = it.name;
          opt.textContent = it.name;
          opt.setAttribute('data-rbd', it.rbd);
          if (it.directorName) opt.setAttribute('data-director', it.directorName);
          sel.appendChild(opt);
        }
      }
    }

    // Autocompletar RBD y Director al cambiar establecimiento
    document.getElementById('establecimiento').addEventListener('change', (e) => {
      const opt = e.target.selectedOptions?.[0];
      const rbd = opt?.getAttribute('data-rbd') || '';
      document.getElementById('rbd').value = rbd;
      const dir = opt?.getAttribute('data-director') || '';
      const dirEl = document.getElementById('director');
      if (dirEl) dirEl.value = dir;
    });

    // Validar horario
    function validateTimes() {
      const hi = document.getElementById('horaInicio').value;
      const ht = document.getElementById('horaTermino').value;
      if (hi && ht && hi >= ht) {
        alert('La hora de t√©rmino debe ser posterior a la hora de inicio.');
        return false;
      }
      return true;
    }

    // Guardar en Firestore con fallback a subcolecci√≥n privada si falta permiso en global
  let currentUserName = null; // se define al cargar perfil
  async function saveForm(user) {
      if (!validateTimes()) return;
      const payload = {
        // Paso 1
        actaNumber: document.getElementById('actaNumber').value,
        fecha: document.getElementById('fecha').value,
        objetivoEstrategico: document.getElementById('objetivoEstrategico').value,
        establecimiento: document.getElementById('establecimiento').value,
        rbd: document.getElementById('rbd').value,
  director: document.getElementById('director')?.value?.trim() || null,
        asesorPrincipal: document.getElementById('asesorPrincipal').value,
        asesorSegundo: document.getElementById('asesorSegundo').value || null,
        horaInicio: document.getElementById('horaInicio').value,
        horaTermino: document.getElementById('horaTermino').value,
        modalidad: document.getElementById('modalidad').value,
        cicloApoyo: document.getElementById('cicloApoyo').value,
        capacidadBasal: document.getElementById('capacidadBasal').value,
        nivelImplementacion: document.getElementById('nivelImplementacion').value,
        rolProfesional: document.getElementById('rolProfesional').value,
        // Paso 2
        objetivoVisita: document.getElementById('objetivoVisita').value.trim(),
        antecedentes: document.getElementById('antecedentes').value.trim() || null,
        instrumentos: document.getElementById('instrumentos').value.trim() || null,
        practicaProblematica: document.getElementById('practicaProblematica').value.trim() || null,
        actividadesRealizadas: document.getElementById('actividadesRealizadas').value.trim() || null,
  acuerdos: document.getElementById('acuerdos').value.trim() || null,
  // Campos opcionales (pueden no existir en el DOM): proteger accesos
  fechaImplementacion: document.getElementById('fechaImplementacion')?.value || null,
  responsables: document.getElementById('responsables')?.value?.trim() || null,
        aspectosPositivos: document.getElementById('aspectosPositivos').value.trim() || null,
  areasMejora: document.getElementById('areasMejora').value.trim() || null,
  // Metadatos base de propiedad
  ownerUid: user?.uid || null,
  ownerEmail: user?.email || null,
  ownerName: currentUserName || user?.displayName || user?.email || null
      };
      if (!payload.objetivoVisita) { alert('El objetivo de la visita es obligatorio.'); return; }

      if (editingId) {
        // Actualizar en colecci√≥n global compartida; si el origen fue sub, creamos copia en global
        try {
          if (editingSrc === 'sub') {
            await addDoc(collection(db, 'datosBasicos'), { ...payload, createdAt: serverTimestamp(), migratedFrom: 'sub', migratedFromId: editingId });
            alert('Documento publicado en compartidos (global).');
          } else {
            await updateDoc(doc(db, 'datosBasicos', editingId), { ...payload, updatedAt: serverTimestamp() });
            alert('Documento actualizado.');
          }
        } catch (e) {
          console.error('Error al guardar/actualizar en compartidos:', e);
          alert('No se pudo guardar/actualizar en compartidos.');
          return;
        }
      } else {
        // Crear: guardar directamente en colecci√≥n global compartida
        try {
          await addDoc(collection(db, 'datosBasicos'), { ...payload, createdAt: serverTimestamp() });
          alert('Guardado en compartidos (global).');
        } catch (e2) {
          console.error('Fallo guardado en compartidos:', e2);
          alert('No se pudo guardar el documento. Verifica tu conexi√≥n y permisos.');
          return;
        }
      }

      // Reset a modo "nuevo"
      editingId = null;
      document.getElementById('btnSubmit').textContent = 'Guardar';
      document.getElementById('datosBasicosForm').reset();
      document.getElementById('actaNumber').value = genActa();
      stepIndex = 0; showStep(stepIndex);
    }

    // Cargar un documento al formulario para edici√≥n
    function loadDocIntoForm(d) {
      // Paso 1
      document.getElementById('actaNumber').value = d.actaNumber || '';
      document.getElementById('fecha').value = toInputDate(d.fecha);
      document.getElementById('objetivoEstrategico').value = d.objetivoEstrategico || '';
      document.getElementById('establecimiento').value = d.establecimiento || '';
      document.getElementById('rbd').value = d.rbd || '';
  const elDir = document.getElementById('director');
  if (elDir) elDir.value = d.director || '';
      document.getElementById('asesorPrincipal').value = d.asesorPrincipal || '';
      document.getElementById('asesorSegundo').value = d.asesorSegundo || '';
      document.getElementById('horaInicio').value = d.horaInicio || '';
      document.getElementById('horaTermino').value = d.horaTermino || '';
      document.getElementById('modalidad').value = d.modalidad || '';
      document.getElementById('cicloApoyo').value = d.cicloApoyo || '';
      document.getElementById('capacidadBasal').value = d.capacidadBasal || '';
      document.getElementById('nivelImplementacion').value = d.nivelImplementacion || '';
      document.getElementById('rolProfesional').value = d.rolProfesional || '';
      // Paso 2
      document.getElementById('objetivoVisita').value = d.objetivoVisita || '';
      document.getElementById('antecedentes').value = d.antecedentes || '';
      document.getElementById('instrumentos').value = d.instrumentos || '';
      document.getElementById('practicaProblematica').value = d.practicaProblematica || '';
      document.getElementById('actividadesRealizadas').value = d.actividadesRealizadas || '';
      document.getElementById('acuerdos').value = d.acuerdos || '';
  // Campos opcionales: asignar solo si existen
  const _fi = document.getElementById('fechaImplementacion');
  if (_fi) _fi.value = toInputDate(d.fechaImplementacion);
  const _resp = document.getElementById('responsables');
  if (_resp) _resp.value = d.responsables || '';
      document.getElementById('aspectosPositivos').value = d.aspectosPositivos || '';
      document.getElementById('areasMejora').value = d.areasMejora || '';
    }

    // Entrar a modo edici√≥n desde una tarjeta
    function startEdit(d) {
      editingId = d._id;
      // Guardar origen para actualizar correctamente
      editingSrc = d._src || 'global';
      editingOwnerUid = d._ownerUid || d.ownerUid || currentUser?.uid || null;
      loadDocIntoForm(d);
      // Activar pesta√±a "Nuevo Documento"
      document.getElementById('tabNuevo').click();
      // Ir a Paso 1
      stepIndex = 0; showStep(stepIndex);
      // Cambiar texto bot√≥n submit
      const btnSubmit = document.getElementById('btnSubmit');
      btnSubmit.textContent = 'Actualizar';
    }

    // Tabs: activa/inactiva con mejor accesibilidad y scroll al cambiar
    const tabNuevo = document.getElementById('tabNuevo');
    const tabGuard = document.getElementById('tabGuardados');
    const secNuevo = document.getElementById('nuevo-documento');
    const secGuard = document.getElementById('documentos-guardados');

    tabNuevo.addEventListener('click', ()=>{
      tabNuevo.classList.add('active'); tabGuard.classList.remove('active');
      tabNuevo.setAttribute('aria-selected','true'); tabGuard.setAttribute('aria-selected','false');
      secNuevo.classList.add('active'); secGuard.classList.remove('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    tabGuard.addEventListener('click', ()=>{
      tabGuard.classList.add('active'); tabNuevo.classList.remove('active');
      tabGuard.setAttribute('aria-selected','true'); tabNuevo.setAttribute('aria-selected','false');
      secGuard.classList.add('active'); secNuevo.classList.remove('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    const form = document.getElementById('datosBasicosForm');
    const steps = Array.from(form.querySelectorAll('.wizard-step'));
    const btnBack = document.getElementById('btnBack');
    const btnNext = document.getElementById('btnNext');
    const btnSubmit = document.getElementById('btnSubmit');
    const btnPreview = document.getElementById('btnPreview');
    let stepIndex = 0;

    function showStep(i) {
      steps.forEach((s, idx) => s.classList.toggle('hidden', idx !== i));
      btnBack.disabled = i === 0;
      btnNext.classList.toggle('hidden', i === steps.length - 1);
      btnSubmit.classList.toggle('hidden', i !== steps.length - 1);
    }

    function validateCurrentStep() {
      const required = steps[stepIndex].querySelectorAll('[required]');
      for (const el of required) {
        if (!el.reportValidity()) return false;
      }
      return true;
    }
    btnNext.addEventListener('click', () => {
      if (!validateCurrentStep()) return;
      stepIndex = Math.min(stepIndex + 1, steps.length - 1);
      showStep(stepIndex);
    });
    btnBack.addEventListener('click', () => {
      stepIndex = Math.max(stepIndex - 1, 0);
      showStep(stepIndex);
    });
    // Inicial
    showStep(stepIndex);

    // Helpers UI (faltaban y causaban ReferenceError)
    function formatDate(d) {
      if (!d) return '';
      try {
        // Firestore Timestamp o Date/string
        const dt = (d && typeof d === 'object' && 'seconds' in d)
          ? new Date(d.seconds * 1000)
          : new Date(d);
        if (isNaN(dt.getTime())) return '';
        return dt.toLocaleDateString('es-CL', { year:'numeric', month:'2-digit', day:'2-digit' });
      } catch { return ''; }
    }
    function truncate(s, n = 120) {
      s = (s ?? '').toString();
      return s.length > n ? s.slice(0, n).trim() + '‚Ä¶' : s;
    }

    // NUEVO: fecha para inputs type="date" (YYYY-MM-DD)
    function toInputDate(val) {
      if (!val) return '';
      const dt = (typeof val === 'object' && 'seconds' in val) ? new Date(val.seconds * 1000) : new Date(val);
      if (isNaN(dt.getTime())) return '';
      const p = n => String(n).padStart(2, '0');
      return `${dt.getFullYear()}-${p(dt.getMonth() + 1)}-${p(dt.getDate())}`;
    }

  // Estado de edici√≥n
  let allDocs = [];
  let filtered = [];
  let editingId = null; // <= id del doc en edici√≥n
  let editingSrc = 'global'; // 'global' | 'sub'
  let editingOwnerUid = null;

    // Estad√≠sticas
    function renderStats(list){
      document.getElementById('statTotal').textContent = list.length;
      const estSet = new Set(list.map(x=>x.establecimiento).filter(Boolean));
      document.getElementById('statEst').textContent = estSet.size;
      const now = new Date(); const ym = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');
      const thisMonth = list.filter(x=>{
        const f = x.fecha || x.createdAt;
        if (!f) return false;
        const dd = (f.seconds? new Date(f.seconds*1000): new Date(f));
        const ymm = dd.getFullYear()+'-'+String(dd.getMonth()+1).padStart(2,'0');
        return ymm===ym;
      }).length;
      document.getElementById('statMes').textContent = thisMonth;
      const asesSet = new Set(list.map(x=>x.asesorPrincipal).filter(Boolean));
      document.getElementById('statAses').textContent = asesSet.size;
    }

    // NUEVO: referencia al contenedor de resultados (fix ReferenceError)
    const resultsEl = document.getElementById('results');

    // Render resultados (ajuste: usar modal en "view" y corregir style inv√°lido del header)
  function renderList(list){
      resultsEl.innerHTML = '';
      if (!list.length){
        resultsEl.innerHTML = '<div class="doc-card"><em>No hay resultados.</em></div>';
        return;
      }
      list.forEach(d=>{
        const el = document.createElement('div');
        el.className = 'doc-card';
  // Edici√≥n para todos; eliminaci√≥n solo autor o admin
  const canEdit = true;
  const canDelete = ((d.ownerUid && currentUser && d.ownerUid === currentUser.uid) || currentUserRole === 'admin');
  const editBtn = '<button type="button" class="btn-sm btn-edit" data-act="edit">Editar</button>';
        const delBtn = canDelete
          ? '<button type="button" class="btn-sm btn-del" data-act="del">Eliminar</button>'
          : '<button type="button" class="btn-sm btn-del" data-act="del" disabled title="Solo autor o admin">Eliminar</button>';
        el.innerHTML = `
          <div class="doc-header" style="margin: 1rem;">
            <span class="badge">${d.actaNumber || 'SIN-ACTA'}</span>
            <span style="font-size:.8rem;opacity:.7;">${formatDate(d.createdAt || d.fecha)}</span>
          </div>
          <h3 style="margin:.2rem 0 1rem; text-align:center;">${d.establecimiento || '‚Äî'}</h3>
          <div class="doc-meta">
            <span style="margin-left: 1.5rem;">ü™™ RBD: <strong>${d.rbd || '‚Äî'}</strong></span>
            <span>‚è∞ ${d.horaInicio || '‚Äî'} - ${d.horaTermino || '‚Äî'}</span>
            <span>üë§ ${d.asesorPrincipal || '‚Äî'}</span>
            <span>üìç ${d.modalidad || '‚Äî'}</span>
      <span title="Creado por">üßë ${d.ownerName || d.ownerEmail || (d.ownerUid ? ('UID ‚Ä¢‚Ä¢‚Ä¢' + String(d.ownerUid).slice(-4)) : '‚Äî')}</span>
          </div>
          <div class="obj-preview" style="margin: 1rem;"><strong>Objetivo:</strong> ${truncate(d.objetivoEstrategico || d.objetivoVisita || '')}</div>
          <div class="card-actions">
            <button type="button" class="btn-sm btn-view" data-act="view">Ver Completo</button>
            ${editBtn}
            ${delBtn}
            <button type="button" class="btn-sm btn-pdf" data-act="pdf">PDF</button>
          </div>
        `;
        el.querySelectorAll('button').forEach(b=>{
          b.addEventListener('click', async (e)=>{
            e.preventDefault();
            e.stopPropagation();
            const act = b.getAttribute('data-act');
            if (act==='del'){
              if (!canDelete) { alert('Solo autor o admin puede eliminar.'); return; }
              if (confirm('¬øEliminar este documento?')) {
                try {
                  await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js').then(async m => {
                    if (d._src === 'sub') {
                      const ownerUid = d._ownerUid || d.ownerUid || (currentUser?.uid || '');
                      await m.deleteDoc(m.doc(db, 'users', ownerUid, 'datosBasicos', d._id));
                    } else {
                      await m.deleteDoc(m.doc(db, 'datosBasicos', d._id));
                    }
                  });
                }
                catch (e) { console.error(e); alert('No se pudo eliminar'); }
              }
            } else if (act==='view'){
              openViewModal(d);
            } else if (act==='edit'){
              startEdit(d);
            } else if (act==='pdf'){
              // Exportar/Imprimir solo este documento
              printOne(d);
            }
          });
        });
        resultsEl.appendChild(el);
      });
    }

    // NUEVO: helpers modal
    const viewModal = document.getElementById('viewModal');
    const viewModalBody = document.getElementById('viewModalBody');
    function openViewModal(d){
      if (!viewModal || !viewModalBody) { 
        console.warn('Modal no encontrado, usando fallback'); 
        alert('Vista completa:\n\n' + JSON.stringify(d, null, 2)); 
        return; 
      }
      const f = (v)=> (v && typeof v === 'string' ? v : (v ?? '‚Äî'));
      const dt = formatDate(d.fecha || d.createdAt);
      viewModalBody.innerHTML = `
        <div style="margin-bottom:1rem;">
          <div style="font-size:1.2rem; font-weight:600; color:#111827;">${f(d.establecimiento)}</div>
          <div style="font-size:.85rem; color:#6b7280;">
            ${f(d.rbd)} &bull; ${f(d.horaInicio)} - ${f(d.horaTermino)} &bull; ${f(d.modalidad)}
          </div>
        </div>

        <div style="margin-bottom:1rem;">
          <strong>Objetivo Estrat√©gico:</strong>
          <div style="white-space:pre-wrap;">${f(d.objetivoEstrategico)}</div>
        </div>

        <div style="margin-bottom:1rem;">
          <strong>Objetivo de la Visita:</strong>
          <div style="white-space:pre-wrap;">${f(d.objetivoVisita)}</div>
        </div>

        <div style="margin-bottom:1rem;">
          <strong>Antecedentes:</strong>
          <div style="white-space:pre-wrap;">${f(d.antecedentes)}</div>
        </div>

        <div style="margin-bottom:1rem;">
          <strong>Instrumentos / Insumos:</strong>
          <div style="white-space:pre-wrap;">${f(d.instrumentos)}</div>
        </div>

        <div style="margin-bottom:1rem;">
          <strong>Pr√°ctica Problem√°tica:</strong>
          <div style="white-space:pre-wrap;">${f(d.practicaProblematica)}</div>
        </div>

        <div style="margin-bottom:1rem;">
          <strong>Actividades Realizadas:</strong>
          <div style="white-space:pre-wrap;">${f(d.actividadesRealizadas)}</div>
        </div>

        <div style="margin-bottom:1rem;">
          <strong>Acuerdos:</strong>
          <div style="white-space:pre-wrap;">${f(d.acuerdos)}</div>
        </div>

        <div style="margin-bottom:1rem;">
          <strong>Aspectos Positivos:</strong>
          <div style="white-space:pre-wrap;">${f(d.aspectosPositivos)}</div>
        </div>

        <div>
          <strong>√Åreas de Mejora:</strong>
          <div style="white-space:pre-wrap;">${f(d.areasMejora)}</div>
        </div>
      `;
      viewModal.classList.remove('hidden');
      document.body.classList.add('modal-open');
    }

    // NUEVO: cerrar modal (ESC, bot√≥n Cerrar, X y clic fuera) ‚Äî FIX: la funci√≥n estaba incompleta
    function closeViewModal(){
      if (!viewModal) return;
      viewModal.classList.add('hidden');
      document.body.classList.remove('modal-open');
      if (viewModalBody) viewModalBody.innerHTML = '';
    }
    // Cerrar al hacer clic en el fondo o en elementos con data-close-view (bot√≥n Cerrar y la ‚ÄúX‚Äù)
    viewModal?.addEventListener('click', (e)=>{
      if (e.target === viewModal || e.target.closest?.('[data-close-view]')) {
        closeViewModal();
      }
    });
    // Cerrar con tecla ESC
    window.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape' && !viewModal.classList.contains('hidden')) {
        closeViewModal();
      }
    });

    // NUEVO: filtros y b√∫squeda
    const searchInput = document.getElementById('searchBox');
    const btnSearch = document.getElementById('btnSearch');
    const btnClear = document.getElementById('btnClear');
    let quickFilter = 'Todos';

    function applyFilters(){
      const q = (searchInput?.value || '').trim().toLowerCase();
      let list = [...allDocs];

      if (quickFilter === 'Presencial' || quickFilter === 'Remoto' || quickFilter === 'H√≠brida') {
        list = list.filter(x => (x.modalidad || '').toLowerCase() === quickFilter.toLowerCase());
      } else if (quickFilter === 'Recientes') {
        list = list.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)).slice(0,20);
      }

      if (q) {
        const exact = list.filter(x => (x.actaNumber || '').toLowerCase() === q);
        filtered = exact.length ? exact : list.filter(x=>{
          const hay = [
            x.actaNumber, x.establecimiento, x.asesorPrincipal, x.fecha, x.modalidad, x.capacidadBasal, x.cicloApoyo
          ].map(v => (typeof v === 'string' ? v.toLowerCase() : (v?.toString?.().toLowerCase?.() || '')));
          return hay.some(s => s.includes(q));
        });
      } else {
        filtered = list;
      }
      renderStats(filtered);
      renderList(filtered);
    }

    document.querySelectorAll('.chip').forEach(c=>{
      c.addEventListener('click', ()=>{
        document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
        c.classList.add('active');
        quickFilter = c.getAttribute('data-filter') || 'Todos';
        applyFilters();
      });
    });
    btnSearch?.addEventListener('click', (e)=>{ e.preventDefault(); applyFilters(); });
    btnClear?.addEventListener('click', (e)=>{
      e.preventDefault();
      if (searchInput) searchInput.value = '';
      quickFilter = 'Todos';
      document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      document.querySelector('.chip[data-filter="Todos"]')?.classList.add('active');
      applyFilters();
    });

  // Utilidades de estado y reconexi√≥n
  const infoEl = document.getElementById('docsInfo');
  const btnReconnect = document.getElementById('btnReconnect');
  const btnDiag = document.getElementById('btnDiag');
  function showDocsInfo(msg){ if (infoEl) infoEl.textContent = msg || ''; }
  function clearDocsInfo(){ showDocsInfo(''); }

  // Radios de alcance y funci√≥n global de resuscripci√≥n
  let scopeRadioMine = null, scopeRadioTeam = null;
  let globalResubscribe = ()=>{};

    // Suscripci√≥n: solo ‚ÄúMis documentos‚Äù (subcolecci√≥n privada) para evitar bloqueos de permisos
    function subscribeUserDocs(uid){
      const mySubRef = collection(db, 'users', uid, 'datosBasicos');
      let subDocs = [];
      const render = ()=>{
        allDocs = [...subDocs];
        allDocs.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
        applyFilters();
      };
      const unsubSub = onSnapshot(mySubRef, (snap)=>{
        subDocs = snap.docs.map(d=> ({ _id:d.id, _src:'sub', _ownerUid:uid, _path:`users/${uid}/datosBasicos/${d.id}`, ...d.data() }));
        clearDocsInfo();
        if (!subDocs.length) showDocsInfo('A√∫n no tienes documentos. Guarda uno nuevo.');
        render();
      }, async (_err)=>{
        showDocsInfo('No se pudieron leer ‚ÄúMis documentos‚Äù. Intentando una lectura puntual...');
        try {
          const s = await getDocs(mySubRef);
          subDocs = s.docs.map(d=> ({ _id:d.id, _src:'sub', _ownerUid:uid, _path:`users/${uid}/datosBasicos/${d.id}`, ...d.data() }));
          clearDocsInfo();
          if (!subDocs.length) showDocsInfo('A√∫n no tienes documentos.');
          render();
        } catch (e) {
          showDocsInfo('No se pudieron leer ‚ÄúMis documentos‚Äù. Revisa tu conexi√≥n o permisos.');
        }
      });
      return ()=>{ try{unsubSub();}catch{} };
    }

    // NUEVO: suscripci√≥n combinada: propios + compartidos por un usuario espec√≠fico
    function subscribeUserDocsWithShared(uid){
      const SHARED_OWNER_EMAIL = 'francisco.ramos@slepiquique.cl';
      const myRef = query(collection(db,'datosBasicos'), where('ownerUid','==', uid));
      const sharedRef = query(collection(db,'datosBasicos'), where('ownerEmail','==', SHARED_OWNER_EMAIL));
      let myDocs = [];
      let sharedDocs = [];
      const mergeAndRender = ()=>{
        const map = new Map();
        [...myDocs, ...sharedDocs].forEach(doc=>{ map.set(doc._id, doc); });
        allDocs = Array.from(map.values());
        allDocs.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
        applyFilters();
      };
      const unsubMy = onSnapshot(myRef, (snap)=>{
        myDocs = snap.docs.map(d=> ({ _id:d.id, ...d.data() }));
        mergeAndRender();
      }, async (_err)=>{
        try { const s = await getDocs(myRef); myDocs = s.docs.map(d=> ({ _id:d.id, ...d.data() })); mergeAndRender(); } catch {}
      });
      const unsubShared = onSnapshot(sharedRef, (snap)=>{
        sharedDocs = snap.docs.map(d=> ({ _id:d.id, ...d.data() }));
        mergeAndRender();
      }, async (_err)=>{
        try { const s = await getDocs(sharedRef); sharedDocs = s.docs.map(d=> ({ _id:d.id, ...d.data() })); mergeAndRender(); } catch {}
      });
      return ()=>{ try{unsubMy();}catch{} try{unsubShared();}catch{} };
    }
    function subscribeAllDocs(){
      const cRef = collection(db,'datosBasicos');
      return onSnapshot(cRef, (snap)=>{
        allDocs = snap.docs.map(d=> ({ _id:d.id, ...d.data() }));
        allDocs.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
        clearDocsInfo();
        applyFilters();
      }, async (err)=>{
        // Si es permiso-denegado, cambiar a "Mis documentos"
        if (err?.code === 'permission-denied' && scopeRadioMine && scopeRadioTeam) {
          scopeRadioMine.checked = true;
          scopeRadioTeam.checked = false;
          showDocsInfo('Sin permiso para ver ‚ÄúEquipo‚Äù. Cambiando a ‚ÄúMis documentos‚Äù.');
          try { globalResubscribe(); } catch {}
          return () => {};
        }
        showDocsInfo('No se pudo leer ‚ÄúEquipo (todos)‚Äù. Intentando lectura puntual...');
        try {
          const s = await getDocs(cRef);
          allDocs = s.docs.map(d=> ({ _id:d.id, ...d.data() }));
          clearDocsInfo();
          applyFilters();
        } catch (e) {
          showDocsInfo('No se pudo leer ‚ÄúEquipo‚Äù. Revisa permisos o conexi√≥n.');
        }
      });
    }

  // Visibilidad fija: no hay radios ni cambios
  function updateScopeVisibility(){}

  // NUEVO: restaurar onAuthStateChanged para cargar y suscribirse
    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.replace('../index.html'); return; }
      currentUser = user;
      await loadProfile(user.uid, user.email);
      // guardar nombre usado en guardado
      try {
        currentUserName = userNameEl?.textContent || user.displayName || user.email || null;
      } catch {}
      await loadEstablecimientos();
      updateScopeVisibility();

      document.getElementById('datosBasicosForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          await saveForm(user);
        } catch (err) {
          console.error('Error al guardar:', err);
          alert('No se pudieron guardar los datos. Revisa consola.');
        }
      });

      // Suscripci√≥n fija: Mis documentos
  let unsubDocs = null;
  function resub(){
        try { unsubDocs && unsubDocs(); } catch {}
        unsubDocs = subscribeAllDocs();
      }
  globalResubscribe = resub;
  resub();
  // Eventos de conectividad y bot√≥n Reconectar
  btnReconnect?.addEventListener('click', ()=>{ showDocsInfo('Reconectando...'); resub(); });
  window.addEventListener('online', ()=>{ showDocsInfo('Conectado. Actualizando...'); resub(); });
  window.addEventListener('offline', ()=>{ showDocsInfo('Est√°s sin conexi√≥n (offline).'); });
      btnDiag?.addEventListener('click', async ()=>{
        try {
          showDocsInfo('Diagn√≥stico: probando conexi√≥n y permisos...');
          // 1) Ping: intentar getDocs en colecci√≥n global compartida
          try {
            const cref = collection(db, 'datosBasicos');
            await getDocs(cref);
          } catch (e) {
            console.error('Diag global:', e);
            throw e;
          }
          showDocsInfo('Diagn√≥stico OK: Firestore responde para documentos compartidos.');
        } catch (e) {
          showDocsInfo('Diagn√≥stico: fallo general. Revisa conexi√≥n y sesi√≥n.');
        }
      });

      // Deep-link: abrir documento por ID v√≠a ?id= o ?doc= (modo opcional ?mode=edit|view)
      async function openDocFromQuery(){
        try{
          const qs = new URLSearchParams(location.search);
          let targetId = qs.get('id') || qs.get('doc');
          if (!targetId) {
            // Intentar detectar en hash o path
            const hash = (location.hash || '').replace(/^#/, '');
            const path = location.pathname || '';
            const rxId = /[A-Za-z0-9_-]{16,36}/g;
            const fromHash = hash.match(rxId)?.[0];
            const fromPath = path.match(rxId)?.slice(-1)?.[0];
            targetId = fromHash || fromPath || '';
          }
          if (!targetId) return; // sin ID, no hacemos nada
          const mode = (qs.get('mode') || 'view').toLowerCase();
          showDocsInfo('Abriendo documento‚Ä¶');
          // 1) Intentar en colecci√≥n global
          try{
            const gref = doc(db, 'datosBasicos', targetId);
            const gs = await getDoc(gref);
            if (gs.exists()){
              const d = { _id: targetId, _src:'global', _ownerUid: gs.data().ownerUid || null, ...gs.data() };
              // Forzar alcance Equipo para coherencia visual si no es admin, solo si tiene permiso de lectura
              if (scopeRadioTeam && scopeRadioMine && scopeRadioTeam.checked === false) {
                scopeRadioTeam.checked = true; scopeRadioMine.checked = false;
                try { globalResubscribe(); } catch {}
              }
              clearDocsInfo();
              if (mode === 'edit') startEdit(d); else openViewModal(d);
              return;
            }
          }catch(e){ /* puede ser permiso-denegado, seguimos a subcolecci√≥n */ }
          // 2) Intentar en subcolecci√≥n del usuario actual
          try{
            const sref = doc(db, 'users', currentUser.uid, 'datosBasicos', targetId);
            const ss = await getDoc(sref);
            if (ss.exists()){
              const d = { _id: targetId, _src:'sub', _ownerUid: currentUser.uid, ...ss.data() };
              if (scopeRadioMine && scopeRadioTeam) { scopeRadioMine.checked = true; scopeRadioTeam.checked = false; try{ globalResubscribe(); }catch{} }
              clearDocsInfo();
              if (mode === 'edit') startEdit(d); else openViewModal(d);
              return;
            }
          }catch(e){ /* ignorar y reportar */ }
          showDocsInfo('No se encontr√≥ el documento o no tienes permisos para verlo.');
        } catch { /* noop */ }
      }
      // Ejecutar despu√©s de la primera suscripci√≥n
      try { openDocFromQuery(); } catch {}

      const cleanup = ()=>{ try{unsubDocs&&unsubDocs();}catch{} };
      window.addEventListener('pagehide', cleanup);
      document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState === 'hidden') cleanup(); });
    });

    // NUEVO: vista previa (ya existente arriba)
    function buildPreviewFromForm(){
      const v = id => (document.getElementById(id)?.value ?? '').toString();
      return {
        // Paso 1
        actaNumber: v('actaNumber'),
        fecha: v('fecha'), // formato input date
        objetivoEstrategico: v('objetivoEstrategico').trim(),
        establecimiento: v('establecimiento'),
        rbd: v('rbd'),
  director: v('director').trim(),
        asesorPrincipal: v('asesorPrincipal'),
        asesorSegundo: v('asesorSegundo'),
        horaInicio: v('horaInicio'),
        horaTermino: v('horaTermino'),
        modalidad: v('modalidad'),
        cicloApoyo: v('cicloApoyo'),
        capacidadBasal: v('capacidadBasal'),
        nivelImplementacion: v('nivelImplementacion'),
        rolProfesional: v('rolProfesional'),
        // Paso 2
        objetivoVisita: v('objetivoVisita').trim(),
        antecedentes: v('antecedentes').trim(),
        instrumentos: v('instrumentos').trim(),
        practicaProblematica: v('practicaProblematica').trim(),
        actividadesRealizadas: v('actividadesRealizadas').trim(),
        acuerdos: v('acuerdos').trim(),
        fechaImplementacion: v('fechaImplementacion'),
        responsables: v('responsables').trim(),
        aspectosPositivos: v('aspectosPositivos').trim(),
        areasMejora: v('areasMejora').trim()
      };
    }
    btnPreview?.addEventListener('click', (e)=>{
      e.preventDefault();
      const data = buildPreviewFromForm();
      openViewModal(data);
    });

    // Construye el contenido imprimible con todos los documentos
    function buildPrintableDoc(d){
      const f = v => {
        const s = (v ?? '').toString().trim();
        return s ? s : '‚Äî';
      };
      const fmt = v => {
        try {
          const dt = (v && typeof v === 'object' && 'seconds' in v) ? new Date(v.seconds*1000) : new Date(v);
          return isNaN(dt.getTime()) ? '' : dt.toLocaleDateString('es-CL', { year:'numeric', month:'2-digit', day:'2-digit' });
        } catch { return ''; }
      };
      // Fallback para nombre de Director/a en documentos antiguos (normalizado y con respaldo)
      const directorName = [d.director, d.directorEstablecimiento, d.directora, d.directorNombre, d.nombreDirector]
        .map(x => (x ?? '').toString().trim())
        .find(Boolean) || '‚Äî';
      // NUEVO: se generan SIEMPRE dos p√°ginas: 1) contenido, 2) firmas
      return `
        <div class="print-page">
          <!-- Encabezado -->
          <div class="print-header">
            <div class="print-logo-cell">
              <img class="print-logo"
                   src="${PRINT_LOGO_URL}"
                   alt="Logo institucional"
                   onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;280&quot; height=&quot;80&quot;><rect width=&quot;100%&quot; height=&quot;100%&quot; fill=&quot;#ffffff&quot;/><text x=&quot;50%&quot; y=&quot;50%&quot; dominant-baseline=&quot;middle&quot; text-anchor=&quot;middle&quot; font-family=&quot;Arial, sans-serif&quot; font-size=&quot;20&quot; fill=&quot;#374151&quot;>SLEP IQUIQUE</text></svg>';"/>
            </div>
            <div class="print-meta-cell">
              <div>
                <div style="font-size:1.15rem;font-weight:700;">
                  ${f(d.establecimiento)} <small style="font-weight:400;opacity:.7;">(${f(d.rbd)})</small>
                </div>
                <div class="print-meta">
                  ${f(d.actaNumber)} <br>
                  <strong>${fmt(d.fecha || d.createdAt)}</strong> ‚Ä¢ ${f(d.modalidad)} ‚Ä¢ ${f(d.horaInicio)||'‚Äî'} - ${f(d.horaTermino)||'‚Äî'}
                  
                </div>
              </div>
            </div>
          </div>

          <!-- Cuerpo (solo contenidos) -->
          <div class="print-section"><strong>Objetivo Estrat√©gico:</strong><div style="white-space:pre-wrap;">${f(d.objetivoEstrategico)}</div></div>
          
          <table class="print-meta-table" style="width:100%">
            <tr>
              <th>Ciclo de Apoyo T√©cnico Pedag√≥gica</th>
              <th>Capacidad Basal Focalizada</th>
            </tr>
            <tr>
              <th><strong>${f(d.cicloApoyo)}</strong></th>
              <th><strong>${f(d.capacidadBasal)}</strong></th>
            </tr>
          </table>
          <br>          
          <table class="print-meta-table" style="width:100%">
            <tr>
              <th>Nivel de Implementaci√≥n Capacidad Basal</th>
              <th>Rol profesional Acompa√±amiento</th>
            </tr>
            <tr>
              <th><strong>${f(d.nivelImplementacion)}</strong></th>
              <th><strong>${f(d.rolProfesional)}</strong></th>
            </tr>
          </table>
          <br>
          <div class="print-section"><strong>Objetivo de la Visita:</strong><div style="white-space:pre-wrap;">${f(d.objetivoVisita)}</div></div>
          <div class="print-section"><strong>Antecedentes:</strong><div style="white-space:pre-wrap;">${f(d.antecedentes)}</div></div>
          <div class="print-section"><strong>Instrumentos / Insumos:</strong><div style="white-space:pre-wrap;">${f(d.instrumentos)}</div></div>
          <div class="print-section"><strong>Pr√°ctica Problem√°tica:</strong><div style="white-space:pre-wrap;">${f(d.practicaProblematica)}</div></div>
          <div class="print-section"><strong>Actividades Realizadas:</strong><div style="white-space:pre-wrap;">${f(d.actividadesRealizadas)}</div></div>
          <div class="print-section"><strong>Acuerdos:</strong><div style="white-space:pre-wrap;">${f(d.acuerdos)}</div></div>
          <div class="print-section"><strong>Aspectos Positivos:</strong><div style="white-space:pre-wrap;">${f(d.aspectosPositivos)}</div></div>
          <div class="print-section"><strong>√Åreas de Mejora:</strong><div style="white-space:pre-wrap;">${f(d.areasMejora)}</div></div>
        </div>

        <!-- P√°gina 2: Firmas (siempre separada) -->
        <div class="print-page">
          <!-- Encabezado (repetido para claridad) -->
          <div class="print-header">
            <div class="print-logo-cell">
              <img class="print-logo"
                   src="${PRINT_LOGO_URL}"
                   alt="Logo institucional"
                   onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;280&quot; height=&quot;80&quot;><rect width=&quot;100%&quot; height=&quot;100%&quot; fill=&quot;#ffffff&quot;/><text x=&quot;50%&quot; y=&quot;50%&quot; dominant-baseline=&quot;middle&quot; text-anchor=&quot;middle&quot; font-family=&quot;Arial, sans-serif&quot; font-size=&quot;20&quot; fill=&quot;#374151&quot;>SLEP IQUIQUE</text></svg>';"/>
            </div>
            <div class="print-meta-cell">
              <div>
                <div style="font-size:1.05rem;font-weight:750;">Firmas y validaci√≥n</div>
                <div class="print-meta">
                  ${f(d.actaNumber)} ‚Ä¢ <strong>${fmt(d.fecha || d.createdAt)}</strong> ‚Ä¢ ${f(d.establecimiento)} (${f(d.rbd)})
                </div>
              </div>
            </div>
          </div>

          <!-- Firmas (nunca se parten entre p√°ginas) -->
          <div class="print-sign-row">
            <div class="print-sign-box">
              <div class="print-sign-line"></div>
              <div class="print-sign-label">Asesor/a Principal: <span class="sign-name">${f(d.asesorPrincipal)}</span></div>
            </div>
            <div class="print-sign-box">
              <div class="print-sign-line"></div>
              <div class="print-sign-label">Director/a de Establecimiento: <span class="sign-name">${directorName}</span></div>
            </div>
            <div class="print-sign-box">
              <div class="print-sign-line"></div>
              <div class="print-sign-label">Asesor/a Segundo/a: <span class="sign-name">${f(d.asesorSegundo)}</span></div>
            </div>
          </div>
        </div>
      `;
    }

    // Esperar a que carguen las im√°genes dentro de un contenedor (m√°x. timeout)
    function waitImagesIn(container, timeoutMs = 1500){
      try{
        const imgs = Array.from(container.querySelectorAll('img'));
        if (!imgs.length) return Promise.resolve();
        const waits = imgs.map(img => new Promise(res => {
          if (img.complete && img.naturalWidth > 0) return res();
          const done = ()=>{ img.removeEventListener('load', done); img.removeEventListener('error', done); res(); };
          img.addEventListener('load', done);
          img.addEventListener('error', done);
        }));
        const t = new Promise(res => setTimeout(res, timeoutMs));
        return Promise.race([Promise.all(waits), t]);
      }catch{ return Promise.resolve(); }
    }

    // Limpia el contenedor tras imprimir
    window.addEventListener('afterprint', ()=>{
      const container = document.getElementById('printAll');
      if (container){ container.innerHTML = ''; container.style.display = 'none'; }
    });

    // Bot√≥n PDF (todos): usa la lista filtrada si existe, si no, todos
    const btnPrintAll = document.getElementById('btnPrintAll');
    btnPrintAll?.addEventListener('click', (e)=>{
      e.preventDefault();
      const rows = (typeof filtered!=='undefined' && filtered.length) ? filtered : (typeof allDocs!=='undefined' ? allDocs : []);
      printAll(rows);
    });

    async function printOne(d){
      const container = document.getElementById('printAll');
      if (!container) { console.warn('Contenedor de impresi√≥n no encontrado'); return; }
      container.innerHTML = buildPrintableDoc(d);
      container.style.display = 'block';
      const prevTitle = document.title;
      if (d?.actaNumber) document.title = d.actaNumber; // √∫til al ‚ÄúGuardar como PDF‚Äù
      await waitImagesIn(container, 1500);
      window.print();
      setTimeout(()=>{ document.title = prevTitle; }, 300);
    }

    async function printAll(list){
      const container = document.getElementById('printAll');
      if (!container) { console.warn('Contenedor de impresi√≥n no encontrado'); return; }
      const rows = (list && list.length) ? list : (typeof allDocs!=='undefined' ? allDocs : []);
      if (!rows.length){ alert('No hay datos para imprimir.'); return; }
      container.innerHTML = rows.map(buildPrintableDoc).join('');
      container.style.display = 'block';
      await waitImagesIn(container, 1800);
      window.print();
    }
  </script>
  <script>
    // Dropdown ligero: toggle, click fuera y ESC
    (function(){
      const dd = document.querySelector('.nav-acomp-dropdown');
      const btn = dd?.querySelector('.dropdown-toggle');
      function close(){ if(!dd) return; dd.classList.remove('open'); btn?.setAttribute('aria-expanded','false'); }
      function toggle(){ if(!dd) return; const open = dd.classList.toggle('open'); btn?.setAttribute('aria-expanded', open ? 'true' : 'false'); }
      btn?.addEventListener('click', (e)=>{ e.stopPropagation(); toggle(); });
      document.addEventListener('click', (e)=>{ if(!dd) return; if(!dd.contains(e.target)) close(); });
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
    })();
  </script>
</body>

</html>