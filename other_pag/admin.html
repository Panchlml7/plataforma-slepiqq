<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Administración de Usuarios - SLEP IQUIQUE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    main { max-width: 1100px; margin: 0 auto; padding: 1rem; }
    h1 { margin: .5rem 0 1rem; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:1rem; }
    table { width:100%; border-collapse: collapse; }
    th, td { border:1px solid #e5e7eb; padding:.5rem; text-align:left; }
    th { background:#f8fafc; }
    .actions { display:flex; gap:.4rem; flex-wrap:wrap; }
    .badge { display:inline-block; padding:.15rem .4rem; border-radius:999px; font-size:.7rem; background:#eef2ff; color:#3730a3; }
    .muted { opacity:.75; font-size:.85rem; }
    .top { display:flex; justify-content:space-between; align-items:center; gap:.8rem; margin-bottom:.8rem; }
    .btn { padding:.45rem .7rem; border-radius:8px; border:1px solid #e5e7eb; background:#111827; color:#fff; cursor:pointer; }
    .btn.secondary { background:#374151; }
    .btn.warn { background:#b91c1c; }
    .filter-row { display:flex; gap:.5rem; align-items:center; margin:.6rem 0; }
    input, select { padding:.4rem .5rem; border:1px solid #cbd5e1; border-radius:8px; }
    .hint { font-size:.8rem; color:#374151; }
  </style>
  <meta name="robots" content="noindex, nofollow">
  <meta name="referrer" content="no-referrer">
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <nav class="top-nav">
    <span class="brand">SLEP IQQ</span>
    <a class="nav-link" href="asistencia.html">Asistencia</a>
    <a class="nav-link" href="establecimiento.html">Establecimiento</a>
    <a class="nav-link" href="documentos.html">Acompañamiento Visita</a>
    <a class="nav-link" href="../plataforma.html">INICIO</a>
    <span class="user-badge"><span id="userName">...</span><button id="logoutBtn" class="btn" type="button">Salir</button></span>
  </nav>
</head>
<body>
  <main>
    <div class="top">
      <h1>Administración de Usuarios</h1>
      <div class="hint">Solo disponible para rol <strong>admin</strong>.</div>
    </div>

    <div class="card" style="margin-bottom:1rem;">
      <div class="filter-row">
        <input type="text" id="q" placeholder="Buscar por email o nombre" style="flex:1;">
        <select id="roleFilter">
          <option value="">Rol (todos)</option>
          <option>admin</option>
          <option>editor</option>
          <option>lector</option>
        </select>
        <button class="btn" id="btnRefresh">Actualizar</button>
      </div>
      <div class="hint">Consejo: puedes filtrar y luego editar roles/estado en línea; recuerda Guardar.</div>
    </div>

    <div class="card">
      <div style="overflow:auto;">
        <table id="userTable">
          <thead>
            <tr>
              <th>Email</th>
              <th>Nombre</th>
              <th>Rol</th>
              <th>Deshabilitado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="5" class="muted">Cargando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <p class="muted" style="margin-top:.8rem;">Notas: Crear/Deshabilitar cuentas del sistema de autenticación requiere Admin SDK (Cloud Functions). Aquí gestionas rol y estado lógico de la app; el acceso se bloquea si el usuario está marcado como deshabilitado.</p>
  </main>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, getDoc, collection, getDocs, updateDoc, setDoc, serverTimestamp, query } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = { apiKey: "AIzaSyDzUGdJT-eyYjKtej63iThVLgvTHVzvxvA", authDomain: "ia-slep-iqq.firebaseapp.com", projectId: "ia-slep-iqq", storageBucket: "ia-slep-iqq.appspot.com", messagingSenderId: "528895424744", appId: "1:528895424744:web:7144f5e5db1bce5ffb315d" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userNameEl = document.getElementById('userName');
    const logoutBtn = document.getElementById('logoutBtn');
    const tableBody = document.querySelector('#userTable tbody');
    const qInput = document.getElementById('q');
    const roleFilter = document.getElementById('roleFilter');
    const btnRefresh = document.getElementById('btnRefresh');

    function norm(s){ return (s??'').toString().trim(); }

    async function requireAdmin(uid, email){
      const snap = await getDoc(doc(db, 'users', uid));
      const data = snap.exists()? snap.data(): {};
      if (data.disabled){
        alert('Tu cuenta está deshabilitada.');
        await signOut(auth);
        location.replace('../index.html');
        return false;
      }
      const role = norm(data.role).toLowerCase();
      if (role !== 'admin'){
        alert('Acceso restringido a administradores.');
        location.replace('../plataforma.html');
        return false;
      }
      userNameEl.textContent = data.name || email || uid;
      return true;
    }

    async function loadUsers(){
      tableBody.innerHTML = '<tr><td colspan="5" class="muted">Cargando...</td></tr>';
      const qRef = query(collection(db, 'users'));
      const snap = await getDocs(qRef);
      const items = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
      renderTable(items);
    }

    function renderTable(items){
      const q = norm(qInput.value).toLowerCase();
      const rf = norm(roleFilter.value).toLowerCase();
      const filtered = items.filter(u=>{
        const hit = (u.email||'').toLowerCase().includes(q) || (u.name||'').toLowerCase().includes(q);
        const roleOk = !rf || (norm(u.role).toLowerCase()===rf);
        return hit && roleOk;
      }).sort((a,b)=> (a.email||'').localeCompare(b.email||''));
      if (!filtered.length){ tableBody.innerHTML = '<tr><td colspan="5" class="muted">Sin resultados.</td></tr>'; return; }
      tableBody.innerHTML = '';
      for (const u of filtered){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.email||'—'}</td>
          <td>${u.name||'—'}</td>
          <td>
            <select data-act="role">
              <option value="admin" ${norm(u.role)==='admin'?'selected':''}>admin</option>
              <option value="editor" ${norm(u.role)==='editor'?'selected':''}>editor</option>
              <option value="lector" ${norm(u.role)==='lector'?'selected':''}>lector</option>
            </select>
          </td>
          <td style="text-align:center;"><input type="checkbox" data-act="disabled" ${u.disabled? 'checked':''}></td>
          <td class="actions">
            <button class="btn secondary" data-act="save">Guardar</button>
            <button class="btn" data-act="reset">Enviar reset contraseña</button>
          </td>
        `;
        tr.querySelector('[data-act="save"]').addEventListener('click', async ()=>{
          const role = tr.querySelector('[data-act="role"]').value;
          const disabled = tr.querySelector('[data-act="disabled"]').checked;
          try{
            await setDoc(doc(db,'users', u.id), {
              email: u.email || null,
              name: u.name || null,
              role,
              disabled: !!disabled,
              updatedAt: serverTimestamp()
            }, { merge: true });
            alert('Guardado');
          }catch(e){ console.error(e); alert('No se pudo guardar'); }
        });
        tr.querySelector('[data-act="reset"]').addEventListener('click', async ()=>{
          if (!u.email){ alert('No hay email asociado.'); return; }
          try{
            await sendPasswordResetEmail(auth, u.email);
            alert('Correo de restablecimiento enviado.');
          }catch(e){ console.error(e); alert('No se pudo enviar el correo. Verifica que el usuario exista en Auth.'); }
        });
        tableBody.appendChild(tr);
      }
    }

    btnRefresh.addEventListener('click', loadUsers);
    qInput.addEventListener('input', loadUsers);
    roleFilter.addEventListener('change', loadUsers);

    logoutBtn.addEventListener('click', async ()=>{
      try{ await signOut(auth); location.replace('../index.html'); }catch(e){ alert('Error al salir'); }
    });

    onAuthStateChanged(auth, async (user)=>{
      if (!user){ location.replace('../index.html'); return; }
      const ok = await requireAdmin(user.uid, user.email);
      if (!ok) return;
      await loadUsers();
    });
  </script>
</body>
</html>
